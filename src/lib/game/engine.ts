import type { Attributes, LifeStage } from "./types";

const STAGES: LifeStage[] = [
  "birth",
  "childhood",
  "youth",
  "adulthood",
  "middle_age",
  "elder",
];

export function getNextStage(current: LifeStage): LifeStage | null {
  const idx = STAGES.indexOf(current);
  if (idx === -1 || idx >= STAGES.length - 1) return null;
  return STAGES[idx + 1];
}

export function generateRandomAttributes(): Attributes {
  // 每个属性独立：30% 概率极端值 (5-25 或 75-95)，70% 概率普通值 (25-75)
  const rand = () => {
    const roll = Math.random();
    if (roll < 0.15) return Math.floor(Math.random() * 21) + 5;   // 5-25 低
    if (roll < 0.30) return Math.floor(Math.random() * 21) + 75;  // 75-95 高
    return Math.floor(Math.random() * 51) + 25;                    // 25-75 普通
  };
  return {
    happiness: rand(),
    wealth: rand(),
    health: rand(),
    intelligence: rand(),
    charisma: rand(),
    luck: rand(),
  };
}

// 随机背景种子，注入 prompt 增加多样性（各 100 个）
const ERAS = [
  // 亚洲
  "1920年代军阀混战的北京", "1937年淞沪会战前夕的上海", "1955年的中国农村人民公社",
  "1966年文化大革命中的成都", "1980年代改革开放的广东", "1990年代下岗潮的东北小城",
  "2000年代互联网兴起的杭州", "2015年创业热潮的深圳", "1950年代朝鲜战争中的平壤",
  "1960年代的香港九龙城寨", "1945年战后的日本广岛", "1980年代经济腾飞的日本东京",
  "1997年亚洲金融风暴的曼谷", "1975年的越南西贡", "2000年代初的印度班加罗尔",
  "1947年印巴分治的拉合尔", "1970年代红色高棉的金边", "2010年代的新加坡",
  "1950年代的台湾眷村", "1960年代的蒙古大草原",
  // 欧洲
  "1940年代二战中的伦敦", "1960年代摇滚乐兴起的利物浦", "1990年代的柏林（刚统一）",
  "1930年代纳粹崛起的慕尼黑", "1968年学生运动的巴黎", "1970年代的苏联莫斯科",
  "1980年代铁幕下的华沙", "1917年十月革命的彼得格勒", "2010年代债务危机的雅典",
  "1940年代中立国瑞士苏黎世", "1970年代北爱尔兰冲突的贝尔法斯特", "1860年代工业革命的曼彻斯特",
  "1990年代南斯拉夫内战的萨拉热窝", "2000年代的冰岛雷克雅未克", "1920年代爵士时代的巴黎",
  "1500年代文艺复兴的佛罗伦萨", "1950年代的西班牙巴塞罗那", "1989年天鹅绒革命的布拉格",
  "1970年代独裁统治下的葡萄牙里斯本", "2020年代的爱沙尼亚塔林（数字国家）",
  // 美洲
  "1930年代大萧条的芝加哥", "1950年代的美国中西部", "1960年代嬉皮士运动的旧金山",
  "1970年代水门事件后的华盛顿", "1980年代毒品战争的迈阿密", "2005年卡特里娜飓风后的新奥尔良",
  "1849年淘金热的加利福尼亚", "1985年的巴西里约贫民窟", "1970年代的阿根廷布宜诺斯艾利斯",
  "1960年代的古巴哈瓦那", "1990年代毒枭横行的哥伦比亚麦德林", "2010年代的墨西哥城",
  "1940年代的加拿大温尼伯", "1970年代军政府的智利圣地亚哥", "1500年代西班牙殖民的秘鲁库斯科",
  "2000年代委内瑞拉经济崩溃的加拉加斯", "1860年代美国南北战争的亚特兰大",
  "1920年代禁酒令时期的纽约", "2010年代硅谷", "1950年代好莱坞黄金时代的洛杉矶",
  // 非洲与中东
  "2005年的尼日利亚拉各斯", "1960年代刚独立的刚果金沙萨", "1994年卢旺达大屠杀前夕的基加利",
  "2010年代的肯尼亚内罗毕", "1970年代的埃塞俄比亚亚的斯亚贝巴", "1950年代种族隔离的南非约翰内斯堡",
  "2011年阿拉伯之春的开罗", "1990年代索马里内战的摩加迪沙", "2010年代的迪拜",
  "1980年代两伊战争的德黑兰", "1948年以色列建国时的耶路撒冷", "2000年代的摩洛哥马拉喀什",
  "1960年代阿尔及利亚独立战争的阿尔及尔", "2020年代的卢旺达基加利（非洲硅谷）",
  "1970年代利比亚的黎波里", "1800年代奥斯曼帝国的伊斯坦布尔",
  // 大洋洲与其他
  "1850年代澳大利亚淘金热的墨尔本", "1970年代的新西兰奥克兰", "2000年代的澳大利亚悉尼",
  "1940年代太平洋战争中的马尼拉", "1960年代的印尼雅加达", "1990年代的柬埔寨暹粒",
  "2010年代的缅甸仰光", "1930年代的满洲国哈尔滨",
];

const FAMILY_TYPES = [
  // 传统/普通
  "一个普通工薪阶层家庭", "农场主的大家庭（7个兄弟姐妹）", "渔村的捕鱼人家",
  "小镇教师家庭", "铁路工人家庭", "煤矿工人家庭", "邮递员的独生子家庭",
  "裁缝铺老板的家庭", "面包师傅的家庭", "出租车司机的家庭",
  // 富裕/权贵
  "一个破产贵族家庭", "一个暴发户家庭", "世代经商的富商家族",
  "政客家族的旁支", "石油大亨家庭", "地产商家庭", "金融世家",
  "珠宝商人家庭", "酒庄庄主家庭", "船运大王家庭",
  // 艺术/特殊职业
  "马戏团杂技世家", "流浪艺人的孩子（没有固定住所）", "京剧世家",
  "画家夫妇的孩子", "摇滚乐手的私生子", "电影导演家庭", "魔术师家庭",
  "芭蕾舞者家庭", "街头涂鸦艺术家的孩子", "木偶戏表演世家",
  // 军警/冒险
  "军人家庭", "警察世家", "消防员家庭", "海军军官家庭",
  "间谍的家庭（父母身份是秘密）", "雇佣兵的孩子", "海盗后裔的家庭",
  "革命者的遗孤", "特种部队退役军人家庭", "边境巡逻员家庭",
  // 宗教/文化
  "寺庙/教堂旁的清贫之家", "传教士家庭", "犹太拉比家庭",
  "穆斯林学者家庭", "佛寺住持收养", "印度教祭司家庭",
  "阿米什人社区家庭", "吉普赛人大篷车家族", "萨满巫师家庭", "修道院附近的弃婴",
  // 边缘/特殊
  "黑帮老大的私生子", "外交官家庭（频繁搬迁）", "科学家夫妇的独生子",
  "单亲妈妈带大", "被爷爷奶奶抚养的留守儿童", "双胞胎中的一个",
  "被收养到外国家庭", "孤儿院长大", "难民家庭", "监狱中出生",
  // 其他
  "游牧民族的帐篷家庭", "船上人家（一辈子住在船上）", "灯塔看守人家庭",
  "边境走私犯家庭", "赌徒的孩子", "考古学家家庭（常年在野外）",
  "动物园管理员家庭", "殡仪馆老板家庭", "矿山主家庭", "国际NGO工作者家庭",
  "被狼群养大后被人发现", "在战争废墟中被士兵捡到", "出生在飞机上的孩子",
  "代孕出生，亲生父母不详", "试管婴儿，父母是同性伴侣", "出生在监狱的母婴房",
  "皇室远亲的落魄后代", "诺贝尔奖获得者的孙辈", "连环杀手的孩子（不知情）",
  "邪教领袖的家庭",
];

const WILD_CARDS = [
  // 自然灾害
  "童年经历一场大地震", "遭遇百年一遇的洪水", "火山爆发摧毁了家园",
  "台风摧毁了整个村庄", "经历严重干旱，庄稼颗粒无收", "雪崩中被埋三天奇迹生还",
  "海啸卷走了半个城镇", "龙卷风摧毁了学校", "森林大火包围了家", "遭遇陨石坠落（近距离目击）",
  // 家庭变故
  "父母其中一方突然失踪", "发现自己是被收养的", "父母离婚引发家族财产大战",
  "家中长辈临终前透露一个惊天秘密", "突然冒出一个同父异母的兄弟姐妹",
  "父母被卷入庞氏骗局倾家荡产", "母亲出走加入了某个神秘组织",
  "父亲因冤案入狱十年", "家族遗产引发亲戚间的血腥争夺", "得知自己有一个失散多年的双胞胎",
  // 意外之财/好运
  "家里意外中了彩票", "在废墟中发现一笔财宝", "继承了一个素未谋面远亲的巨额遗产",
  "捡到一个价值连城的古董", "无意间救了一个重要人物获得巨额报酬",
  "在街头被星探发现", "一张随手拍的照片意外走红全网",
  "误打误撞投资了一家后来上市的公司", "在海边捡到装有藏宝图的漂流瓶", "买到的旧房子墙壁里藏着金条",
  // 天赋/发现
  "被发现有某种罕见天赋", "意外发现自己有绝对音感", "展现出惊人的数学天才",
  "被诊断出罕见的联觉症（能看到声音的颜色）", "发现自己对某种毒物天然免疫",
  "在体育课上展现出超常的运动天赋", "无师自通学会了一门外语", "画的画被美术馆收藏",
  "发明了一个小装置解决了大问题", "在科学竞赛中击败了所有大学生",
  // 事故/创伤
  "家中遭遇火灾失去一切", "被误诊为重病住院半年", "被动物咬伤留下终身伤疤",
  "在一次事故中失去了一根手指", "食物中毒差点丧命", "从高处坠落奇迹生还但留下后遗症",
  "目睹了一场严重车祸", "被困在电梯里整整一天", "游泳时差点溺死被陌生人救起",
  "误食有毒植物导致短暂失明", "被雷击中存活（概率百万分之一）", "坠入冰窟被困数小时",
  // 人际/社会
  "意外结识一位改变命运的陌生人", "被卷入一场冤案", "因为一个误会被学校开除",
  "无意间揭发了一个重大丑闻", "被绑架后机智逃脱", "目睹一场重大历史事件",
  "被卷入一场国际间谍事件", "在法庭上为陌生人作证改变了判决", "被错误地宣布死亡",
  "因为长相酷似某个名人而被卷入麻烦",
  // 奇遇
  "因为一封信改变了人生轨迹", "在逃难途中与家人走散", "家族卷入政治运动",
  "被困在异国他乡三个月无法回家", "在地铁里遇到了未来的人生导师",
  "被选中参加一个秘密实验", "在旧书店里发现了一本改变世界观的书",
  "偶然解开了一个悬案", "在梦中预见了即将发生的事并成功避险",
  "被困在一个与世隔绝的地方学会了生存",
  // 荒诞
  "被一只流浪猫引到了一个秘密地下室", "因为打嗝打了三天上了新闻",
  "在考试中交了白卷却因为出题错误得了满分", "被鸟粪砸中后买了彩票中了奖",
  "因为走错门参加了一场改变命运的面试", "在垃圾堆里翻到了一幅名画",
  "被外星信号选中成为接收者（后来证明是电视干扰）", "因为一只蝴蝶引发了一连串荒诞事件",
  "梦游时完成了一幅杰作", "被错误地列入了某国的通缉名单",
];

function pickRandom<T>(arr: T[]): T {
  return arr[Math.floor(Math.random() * arr.length)];
}

export function generateRandomSeeds(): { era: string; family: string; wildCard: string } {
  return {
    era: pickRandom(ERAS),
    family: pickRandom(FAMILY_TYPES),
    wildCard: pickRandom(WILD_CARDS),
  };
}

export function applyAttributeChanges(
  current: Attributes,
  changes: Partial<Attributes>
): Attributes {
  const clamp = (v: number) => Math.max(0, Math.min(100, v));
  return {
    happiness: clamp(current.happiness + (changes.happiness || 0)),
    wealth: clamp(current.wealth + (changes.wealth || 0)),
    health: clamp(current.health + (changes.health || 0)),
    intelligence: clamp(current.intelligence + (changes.intelligence || 0)),
    charisma: clamp(current.charisma + (changes.charisma || 0)),
    luck: clamp(current.luck + (changes.luck || 0)),
  };
}
